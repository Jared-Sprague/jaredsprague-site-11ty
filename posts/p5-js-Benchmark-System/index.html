<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>p5.js Benchmark System</title>
    <meta name="Description" content="Jared Sprague&#39;s personal website">
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link rel="stylesheet" href="/css/all.min.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml"
          title="Jared Sprague">
    <link rel="stylesheet" href="/css/prism.css">
</head>
<style>
    body, h1, h2, h3, h4, h5, h6 {
        font-family: "Montserrat", sans-serif
    }

    .w3-row-padding img {
        margin-bottom: 12px
    }

    /* Set the width of the sidebar to 120px */
    .w3-sidebar {
        width: 120px;
        background: #222;
    }

    /* Add a left margin to the "page content" that matches the width of the sidebar (120px) */
    #main {
        margin-left: 120px
    }

    /* Remove margins from "page content" on small screens TODO add back in*/
    

    @media only screen and (max-width: 992px) {
        #main {
            margin-left: 0
        }
    }

    @media only screen and (min-height: 950px) {
        #navIcon {
            font-size: 36px !important
        }
    }

    @media only screen and (max-height: 750px) {
        #navIcon {
            padding: 0px;
        }
    }

    

</style>
<body class="w3-black">


<!-- Icon Bar (Sidebar - hidden on small and medium screens) -->
<nav class="w3-sidebar w3-bar-block w3-small w3-hide-small w3-hide-medium w3-center">
    <!-- Avatar image in top left corner -->
    <a href="/"><img src="/img/jared_sprague_pirate_sm.jpg" style="width:100%"></a>

        <a href="/games/"
           class="w3-bar-item w3-button  w3-hover-black ">
            <i class="fas fa-rocket w3-large" id="navIcon"></i>
            <p>Games</p>
        </a>

        <a href="/projects/"
           class="w3-bar-item w3-button  w3-hover-black ">
            <i class="fas fa-flask w3-large" id="navIcon"></i>
            <p>Projects</p>
        </a>

        <a href="/talks/"
           class="w3-bar-item w3-button  w3-hover-black ">
            <i class="fas fa-microphone w3-large" id="navIcon"></i>
            <p>Talks</p>
        </a>

        <a href="/blog/"
           class="w3-bar-item w3-button  w3-hover-black ">
            <i class="fas fa-pen-nib w3-large" id="navIcon"></i>
            <p>Blog</p>
        </a>

        <a href="/#about"
           class="w3-bar-item w3-button  w3-hover-black ">
            <i class="fas fa-user w3-large" id="navIcon"></i>
            <p>About</p>
        </a>

        <a href="/#contact"
           class="w3-bar-item w3-button  w3-hover-black ">
            <i class="fas fa-envelope w3-large" id="navIcon"></i>
            <p>Contact</p>
        </a>
</nav>

<!-- Navbar on small screens (Hidden on medium and large screens) -->
<div class="w3-top w3-hide-large" id="myNavbar">
    <div class="w3-bar w3-black w3-opacity w3-hover-opacity-off w3-center w3-small">
        <a href="/games" class="w3-bar-item w3-button" style="width:20% !important">Games</a>
        <a href="/projects" class="w3-bar-item w3-button" style="width:20% !important">Projects</a>
        <a href="/talks" class="w3-bar-item w3-button" style="width:20% !important">Talks</a>
        <a href="/blog" class="w3-bar-item w3-button" style="width:20% !important">Blog</a>
        <a href="/#about" class="w3-bar-item w3-button" style="width:20% !important">About</a>
    </div>
</div>

<div class="w3-padding-large" id="main">

    <main  class="tmpl-post">
        <div class="w3-content">
<h1>p5.js Benchmark System</h1>

<p><img src="/img/benchmark.jpg" alt="alt text" title="Code"></p>
<p>I was browsing the open <a href="https://github.com/processing/p5.js/issues/1524">p5.js</a> issues when I stubbled across <a href="https://github.com/processing/p5.js/issues/1524">this one</a>. There was an open request to add performance benchmarking to the p5.js development tools, that would run benchmarks in multiple real browsers. The goal was to know when performance optimizations were really helping or adding unnecessary complexity.  That looked like a fun problem to work on.  Since performance testing is one thing I really love doing, I decided to take it on.  I learned A lot in the process.  This post explains the main parts of the of the system I put together,  using existing plugins.  It is copied from the <a href="https://github.com/processing/p5.js/wiki/Benchmarking-p5.js">article on the p5.js wiki</a> .</p>
<h1>Benchmarking p5.js</h1>
<p>We have a grunt task that runs performance benchmarks in multiple real browsers on the developers local machine. It will automatically detect which browsers are installed from the following list (Chrome, Firefox, Safari, Edge, IE) and run the benchmarks in all installed browsers and report the results.</p>
<p>Our benchmarking system consists of 3 main components:</p>
<ol>
<li><a href="https://benchmarkjs.com/">Benchmark.js</a> - the engine that runs the benchmarks and the framework for defining benchmarks.</li>
<li><a href="https://www.npmjs.com/package/karma-benchmark">karma-benchmark</a> - The karma plugin for launching and running the benchmarks in multiple real browsers.</li>
<li><a href="https://www.npmjs.com/package/grunt-karma">grunt-karma</a> - The grunt plugin that allows us to define different karma configuations per grunt command.  This allows us to run single benchmarks or groups of benchmarks.</li>
</ol>
<h2>Basic instructions:</h2>
<h3>Install the new dependancies</h3>
<pre class="language-text"><code class="language-text">npm install</code></pre>
<h3>Do a build, the benchmarks expect a local build of p5.js and p5.min.js</h3>
<pre class="language-text"><code class="language-text">grunt</code></pre>
<h3>Run a specific benchmark</h3>
<pre class="language-text"><code class="language-text">grunt karma:<target_benchmark></code></pre>
<h3>To run all the benchmarks</h3>
<pre class="language-text"><code class="language-text">grunt karma</code></pre>
<h3>Example</h3>
<pre class="language-text"><code class="language-text">grunt karma:random-dev</code></pre>
<p>Outputs:</p>
<pre class="language-text"><code class="language-text">Chrome 62.0.3202 (Linux 0.0.0)<br>  p5 random() vs Math.random(): Math.random() at 95811115 ops/sec (1.26x faster than p5 random())<br>Firefox 56.0.0 (Fedora 0.0.0)<br>  p5 random() vs Math.random(): Math.random() at 2367566507 ops/sec (1.14x faster than p5 random())<br><br>Done, without errors.</code></pre>
<h2>Adding new benchmarks</h2>
<ol>
<li>Create a new benchmark file at this path and name format:  bench/*.bench.js</li>
<li>Write the benchmark here is documentation <a href="https://github.com/JamieMason/karma-benchmark/blob/master/README.md">karma-benchmark</a></li>
<li>Add the benchmark target to <code>grunt-karma.js</code></li>
</ol>
<h3>Example benchmark [random-fe-off.bench.js]</h3>
<p>Here is an example benchmark that compares p5 random() to Math.random() with Friendly Error System disabled. It has two suites one for instanced mode and one using the global window random().</p>
<pre class="language-js"><code class="language-js">p5<span class="token punctuation">.</span>disableFriendlyErrors <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> p5Inst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">p5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> *  Instance random() vs Math.random()<br> */</span><br><span class="token function">suite</span><span class="token punctuation">(</span><span class="token string">'Friendly Errors: OFF, Instance random() vs Math.random()'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">benchmark</span><span class="token punctuation">(</span><span class="token string">'Instance random()'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> p5Inst<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">benchmark</span><span class="token punctuation">(</span><span class="token string">'Math.random()'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><br><span class="token comment">/**<br> *  Window random() vs Math.random()<br> */</span><br><span class="token function">suite</span><span class="token punctuation">(</span><span class="token string">'Friendly Errors: OFF, Window random() vs Math.random()'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">benchmark</span><span class="token punctuation">(</span><span class="token string">'window random()'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">benchmark</span><span class="token punctuation">(</span><span class="token string">'Math.random()'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Then you would need to add your new benchmark to <code>grunt-karma.js</code></p>
<pre class="language-text"><code class="language-text">'random-fe-off-dev': {<br>    options: {<br>      files: [<br>        'lib/p5.js',<br>        'bench/math/random-fe-off.bench.js'<br>      ]<br>    }<br>  }</code></pre>
<p>Now you can run your new benchmark with:</p>
<pre class="language-text"><code class="language-text">grunt karma:random-fe-off-dev</code></pre>
<h2>Comparing Prod to Dev</h2>
<p>karma-benchmark can load remote files.  So it's easy to include the p5.js prod build and compare it to the dev build.  This is important when you're working on improving performance to compare your changes to what is in production.   To do this simply make two targets in <code>grunt-karma.js</code> one for prod and one for dev.</p>
<pre class="language-text"><code class="language-text">  'random-prod': {<br>    options: {<br>      files: [<br>        'https://cdnjs.cloudflare.com/ajax/libs/p5.js/<%= pkg.version %>/p5.js',<br>        'bench/random.bench.js',<br>      ],<br>    },<br>  },<br>  'random-dev': {<br>    options: {<br>      files: [<br>        'lib/p5.js',<br>        'bench/random.bench.js',<br>      ],<br>    },<br>  },</code></pre>
<p>You can see that <code>random-prod</code> actually loads the latest build from CDN.  Then to compare you can run both targets using:</p>
<pre class="language-text"><code class="language-text">grunt karma:random-prod karma:random-dev</code></pre>
<h2>Notes</h2>
<p>I chose to put the grunt-karma tasks in it's own file <code>grunt-karma.js</code>  instead of the main <code>Gruntfile.js</code>, because as we add more benchmarks overtime the file could grow quite long, and I wanted to keep the main Gruntfile clean.</p>


<p><a href="/">← Home</a></p>
</div>
    </main>

    <!-- Footer -->
    <footer class="w3-content w3-padding-32 w3-text-grey w3-xlarge w3-center">
        <div class="w3-text-grey w3-xlarge">
    <a href="https://twitter.com/caramelcode"><i class="fab fa-twitter w3-hover-opacity"></i></a>
    <a href="https://github.com/Jared-Sprague"><i class="fab fa-github w3-hover-opacity"></i></a>
    <a href="https://www.twitch.tv/kamiza"><i class="fab fa-twitch w3-hover-opacity"></i></a>
    <a href="https://www.linkedin.com/in/jaredsprague/"><i class="fab fa-linkedin w3-hover-opacity"></i></a>
    <!-- End footer -->
</div>

        <!-- End footer -->
    </footer>

    <!-- Current page: /posts/p5-js-Benchmark-System/ -->
</div>
</body>
</html>
